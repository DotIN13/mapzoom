diff --git a/node_modules/@zeppos/zml/dist/zml-app.debug.js b/node_modules/@zeppos/zml/dist/zml-app.debug.js
index 18c1e4e..bd1926e 100644
--- a/node_modules/@zeppos/zml/dist/zml-app.debug.js
+++ b/node_modules/@zeppos/zml/dist/zml-app.debug.js
@@ -1 +1 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let t=null;n()?t=hmApp.getPackageInfo:i()&&(t=e("@zos/app").getPackageInfo),n()?hmUI:i()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:i()&&e("@zos/router").push;let s=null;function n(){return o()&&r()}function i(){return o()&&a()}function r(){return"undefined"!=typeof hmApp}function a(){return"undefined"!=typeof __$$R$$__}function o(){return r()||a()}n()?s=hmBle:i()&&(s=e("@zos/ble"));let d=null;n()?d=DeviceRuntimeCore.HmLogger:i()?d=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(d=Logger);const h=e("@zos/utils").EventBus,p=e("@zos/timer").setTimeout,u=e("@zos/timer").clearTimeout;function c(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function l(e,t){const s=c(),n=p((()=>{u(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function f(e){return t=function(e){return JSON.stringify(e)}(e),Buffer.from(t,"utf-8");var t}function y(e){return t=g(e),JSON.parse(t);var t}function g(e){return e.toString("utf-8")}function m(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const I=o()?d.getLogger("device-message"):d.getLogger("side-message");function b(e){switch(e.toLowerCase()){case"json":return 2;case"text":default:return 1;case"bin":return 3;case"empty":return 0}}let k=1e4;function T(){return k++}let L=1e3;function S(){return L++}class w extends h{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.byteLength)return I.error("receive chunk data length error, expect %d but %d",e.payloadLength,e.payload.byteLength),void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`));this.chunks.push(e),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const s=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,s]):s}if(this.finishChunk){if(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength!==this.finishChunk.payloadLength)return I.error("receive full data length error, expect %d but %d",this.finishChunk.payloadLength,this.finishChunk.payload.byteLength),void this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`));this.emit("data",this.finishChunk)}}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class v{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new w(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class B extends Error{constructor(e,t){super(t),this.code=e}}class U extends h{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:i=(o()?s:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?s:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new v,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=c(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=p((()=>{this.shakeStatus=4,this.shakeTask.reject(new B(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&u(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return y(e)}json2Buf(e){return f(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{I.warn("[RAW] [R] receive index=>%d size=>%d bin=>%s",e,s,m(t)),this.onFragmentData(t)})),e&&e(this)}disConnect(e){I.debug("app ble disconnect"),this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{I.warn("[RAW] [R] receive size=>%d bin=>%s",e.byteLength,m(e)),this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){I.info("shake send");const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){I.info("close send");const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const d=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:a,port2:o,appId:d,extra:h,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=!0){if(t&&I.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,m(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=!0){t&&I.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,m(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const a=3518,o=t.byteLength;let d=0;const h=Buffer.alloc(a),p=e||T(),u=S();let c=1;const l=Math.ceil(o/a);function f(){return c++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=o-d,a=Buffer.alloc(0+e);t.copy(a,0,d,d+e),d+=e,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:a,type:s,opCode:1,totalLength:o,contentType:n,dataType:i},{messageType:r});break}t.copy(h,0,d,d+a),d+=a,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:h,type:s,opCode:0,totalLength:o,contentType:n,dataType:i},{messageType:r})}d===o?I.debug("HmProtocol send ok msgSize=> %d dataSize=> %d",d,o):I.error("HmProtocol send error msgSize=> %d dataSize=> %d",d,o)}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=f(t),a=e||T();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||T();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:d},{messageType:h}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:d});let u=this.isDevice?this.buildData(p,{type:h}):p;this.sendMsg(u)}buildPayload(e){const t=66+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.byteLength,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);s+=4;const h=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const u=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt8(s);s+=1;const b=t.readUInt8(s);s+=1;const k=t.readUInt16LE(s);s+=2;const T=t.readUInt32LE(s);s+=4;const L=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:a,totalLength:o,payloadLength:d,payloadType:h,opCode:p,contentType:I,dataType:b,timestamp1:u,timestamp2:c,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:k,extra2:T,extra3:L,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),I.debug("receive data=>",JSON.stringify(t)),1===t.flag&&1===t.type?(this.appSidePort=t.port2,I.debug("shake success appSidePort=>",t.port2),this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag?I.debug("receive runtime => flag %d type %d",t.flag,t.type):1===t.flag&&2===t.type?(this.appSidePort=0,I.debug("receive close =>",this.appSidePort)):I.error("error appSidePort=>%d data=>%j",this.appSidePort,t)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new B(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new B(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t})=>{this.response({requestId:e.traceId,contentType:e.contentType,dataType:e.dataType,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();const s=T(),n=c();t=Object.assign({timeout:6e4,contentType:"json",dataType:"json"},t),this.handlers.set(s,(({traceId:t,payload:i,dataType:r})=>{let a;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),I.debug("traceId=>%d payload=>%s",t,i.toString("hex")),r){case 1:a=g(i);break;case 3:default:a=i;break;case 2:a=y(i)}I.debug("request id=>%d payload=>%j",s,e),I.debug("response id=>%d payload=>%j",s,a),n.resolve(a)})),Buffer.isBuffer(e)?this.sendBuf({requestId:s,buf:e,type:1,contentType:3,dataType:b(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:s,buf:Buffer.from(e),type:1,contentType:3,dataType:b(t.dataType)}):this.sendJson({requestId:s,json:e,type:1,contentType:2,dataType:b(t.dataType)});let i=!1;return Promise.race([l(t.timeout,((n,r)=>{if(i)return n();I.error(`request timeout in ${t.timeout}ms error=> %d data=> %j`,s,e),r(new B(4,`request timed out in ${t.timeout}ms.`))})),n.promise.finally((()=>{i=!0}))]).catch((e=>{throw I.error("error %j",e),e})).finally((()=>{this.handlers.delete(s)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s})}call(e){return this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):this.sendJson({json:e,type:3,contentType:2,dataType:0})))}}const E=d.getLogger("message-builder"),q=e("@zos/ble/TransferFile"),C=(P=new q,{onFile(e){return e?(void 0===P||P.inbox.on("newfile",(function(){const t=P.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===P||P.inbox.on("file",(function(){const t=P.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return P.inbox.emit("file"),this},offFile(){return void 0===P||(P.inbox.off("newfile"),P.inbox.off("file")),this},getFile:()=>void 0===P?null:P.inbox.getNextFile(),sendFile(e,t){if(void 0===P)throw new Error("fileTransfer is not available");return P.outbox.enqueueFile(e,t)}});var P;function D({globalData:e={},onCreate:s,onDestroy:n,...i}={}){return{globalData:e,...i,onCreate(...e){const n=(i=new U({appId:t().appId,appDevicePort:20,appSidePort:0}),{shakeTimeout:5e3,requestTimeout:6e4,onCall(e){return e?(i.on("call",(({payload:t})=>{const s=i.buf2Json(t);e&&e(s)})),this):this},offOnCall(e){return i.off("call",e),this},call(e){return o()&&i.fork(this.shakeTimeout),i.call({jsonrpc:"hmrpcv1",...e})},onRequest(e){return e?(i.on("request",(t=>{const s=i.buf2Json(t.request.payload);e&&e(s,((e,s)=>e?t.response({data:{error:e}}):t.response({data:{result:s}})))})),this):this},cancelAllRequest(){return i.off("response"),this},offOnRequest(e){return i.off("request",e),this},request(e){return o()&&i.fork(this.shakeTimeout),E.debug("current request count=>%d",i.getRequestCount()),i.request({jsonrpc:"hmrpcv1",...e},{timeout:this.requestTimeout}).then((({error:e,result:t})=>{if(e)throw e;return t}))},connect(){return i.connect((()=>{E.debug("DeviceApp messageBuilder connect with SideService")})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),i.disConnect((()=>{E.debug("DeviceApp messageBuilder disconnect SideService")})),this},start(){return i.listen((()=>{E.debug("SideService messageBuilder start to listen to DeviceApp")})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),i.disConnect((()=>{E.debug("SideService messageBuilder stop to listen to DeviceApp")})),this}});var i;this.globalData.messaging=n,n.onCall(this.onCall?.bind(this)).onRequest(this.onRequest?.bind(this)).connect(),C.onFile(this.onReceivedFile?.bind(this)),s?.apply(this,e)},onDestroy(...e){this.globalData.messaging.offOnCall().offOnRequest().disConnect(),C.offFile(),n?.apply(this,e)},httpRequest:e=>messaging.request({method:"http.request",params:e})}}export{D as BaseApp};
+let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let t=null;n()?t=hmApp.getPackageInfo:i()&&(t=e("@zos/app").getPackageInfo),n()?hmUI:i()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:i()&&e("@zos/router").push;let s=null;function n(){return o()&&r()}function i(){return o()&&a()}function r(){return"undefined"!=typeof hmApp}function a(){return"undefined"!=typeof __$$R$$__}function o(){return r()||a()}function d(e){return e?.constructor===Object}n()?s=hmBle:i()&&(s=e("@zos/ble"));let h=null;n()?h=DeviceRuntimeCore.HmLogger:i()?h=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger);const p=e("@zos/utils").EventBus,u=e("@zos/timer").setTimeout,c=e("@zos/timer").clearTimeout;function l(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function f(e,t){const s=l(),n=u((()=>{c(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function y(e){return m(function(e){return JSON.stringify(e)}(e))}function g(e){return t=I(e),JSON.parse(t);var t}function m(e){return Buffer.from(e,"utf-8")}function I(e){return e.toString("utf-8")}function T(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function b(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const S=o()?h.getLogger("device-message"):h.getLogger("side-message"),B="json",k="text",w="bin",E={EMPTY:0,TEXT:1,JSON:2,BIN:3};function v(e){switch(e.toLowerCase()){case B:return E.JSON;case k:return E.TEXT;case w:return E.BIN;case"empty":return E.EMPTY;default:return E.BIN}}let L=1e4;function q(){return L++}let P=1e3;function U(){return P++}class C extends p{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,S.log("Session Created.")}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.length)return S.error("receive chunk data length error, expect %d but %d",e.payloadLength,e.payload.length),void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.length}`));this.tempBuf||(this.tempBuf=Buffer.alloc(e.totalLength));const t=3518*(e.seqId-1);e.payload.copy(this.tempBuf,t),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){if(this.finishChunk){if(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.length,this.finishChunk.totalLength!==this.finishChunk.payloadLength)return S.error("receive full data length error, expect %d but %d",this.finishChunk.payloadLength,this.finishChunk.payload.length),void this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.length}`));this.emit("data",this.finishChunk)}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class x{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new C(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class D extends Error{constructor(e,t){super(t),this.code=e}}class O extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:i=(o()?s:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?s:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new x,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=l(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=u((()=>{this.shakeStatus=4,this.shakeTask.reject(new D(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&c(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return y(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{S.warn("[RAW] [R] receive index=>%d size=>%d bin=>%s",e,s,b(t)),this.onFragmentData(t)})),e&&e(this)}disConnect(e){S.debug("app ble disconnect"),this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{S.warn("[RAW] [R] receive size=>%d bin=>%s",e.length,b(e)),this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.length>this.chunkSize)throw new Error(`${e.payload.length} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){S.info("shake send");const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){S.info("close send");const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const d=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:a,port2:o,appId:d,extra:h,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=!0){if(t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,b(e.buffer)),!this.ble.send(e.buffer,e.length))throw Error("send message error")}sendBinBySide(e,t=!0){t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,b(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const a=3518,o=t.length;let d=0;const h=Buffer.alloc(a),p=e||q(),u=U();let c=1;const l=Math.ceil(o/a);function f(){return c++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=o-d,a=Buffer.alloc(0+e);t.copy(a,0,d,d+e),d+=e,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:a,type:s,opCode:1,totalLength:o,contentType:n,dataType:i},{messageType:r});break}t.copy(h,0,d,d+a),d+=a,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:h,type:s,opCode:0,totalLength:o,contentType:n,dataType:i},{messageType:r})}d===o?S.debug("HmProtocol send ok msgSize=> %d dataSize=> %d",d,o):S.error("HmProtocol send error msgSize=> %d dataSize=> %d",d,o)}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=y(t),a=e||q();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||q();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=m(t),a=e||q();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:d},{messageType:h}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:d});let u=this.isDevice?this.buildData(p,{type:h}):p;this.sendMsg(u)}buildPayload(e){const t=66+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.length,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);s+=4;const h=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const u=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt8(s);s+=1;const T=t.readUInt8(s);s+=1;const b=t.readUInt16LE(s);s+=2;const S=t.readUInt32LE(s);s+=4;const B=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:a,totalLength:o,payloadLength:d,payloadType:h,opCode:p,contentType:I,dataType:T,timestamp1:u,timestamp2:c,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:b,extra2:S,extra3:B,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),S.debug("receive data=>",JSON.stringify(t)),1===t.flag&&1===t.type?(this.appSidePort=t.port2,S.debug("shake success appSidePort=>",t.port2),this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag?S.debug("receive runtime => flag %d type %d",t.flag,t.type):1===t.flag&&2===t.type?(this.appSidePort=0,S.debug("receive close =>",this.appSidePort)):S.error("error appSidePort=>%d data=>%j",this.appSidePort,t)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new D(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new D(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?v(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let s=w;"string"==typeof e?s=k:d(e)?s=B:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(s=w);const n={timeout:6e4,contentType:s,dataType:s},i=q(),r=l();t=Object.assign(n,t),this.handlers.set(i,(({traceId:t,payload:s,dataType:n})=>{let a;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),S.debug("traceId=>%d payload=>%s",t,s.toString("hex")),n){case E.TEXT:a=I(s);break;case E.BIN:a=s;break;case E.JSON:a=g(s);break;default:a=s}S.debug("request id=>%d payload=>%j",i,e),S.debug("response id=>%d payload=>%j",i,a),r.resolve(a)})),Buffer.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:E.BIN,dataType:v(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:E.BIN,dataType:v(t.dataType)}):v(t.contentType)===E.JSON?this.sendJson({requestId:i,json:e,type:1,contentType:E.JSON,dataType:v(t.dataType)}):v(t.contentType)===E.TEXT?this.sendText({requestId:i,text:e,type:1,contentType:E.TEXT,dataType:v(t.dataType)}):this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:E.BIN,dataType:v(t.dataType)});let a=!1;return Promise.race([f(t.timeout,((s,n)=>{if(a)return s();S.error(`request timeout in ${t.timeout}ms error=> %d data=> %j`,i,e),n(new D(4,`request timed out in ${t.timeout}ms.`))})),r.promise.finally((()=>{a=!0}))]).catch((e=>{throw S.error("error %j",e),e})).finally((()=>{this.handlers.delete(i)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){E.BIN===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):E.TEXT===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):E.JSON===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:E.BIN})}call(e){let t=E.JSON;return"string"==typeof e?t=E.TEXT:d(e)?t=E.JSON:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=E.BIN),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:E.BIN,dataType:E.EMPTY}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:E.BIN,dataType:E.EMPTY}):t===E.JSON?this.sendJson({json:e,type:3,contentType:E.JSON,dataType:E.EMPTY}):t===E.TEXT?this.sendText({text:e,type:3,contentType:E.TEXT,dataType:E.EMPTY}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:E.BIN,dataType:E.EMPTY})))}}const N=h.getLogger("message-builder"),j=5e3,$=6e4,R="hmrpcv1",z=20,M=0;function A(){return e=new O({appId:t().appId,appDevicePort:z,appSidePort:M}),{shakeTimeout:j,requestTimeout:$,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case E.JSON:s=g(s);break;case E.TEXT:s=I(s);break;case E.BIN:default:s=T(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=d(t)?opts.contentType?t:{jsonrpc:R,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case E.JSON:s=g(s);break;case E.TEXT:s=I(s);break;case E.BIN:default:s=T(s)}t&&t(s,((t,n,i={})=>e.request.contentType===E.JSON&&s?.jsonrpc===R?t?e.response({data:{jsonrpc:R,error:t}}):e.response({data:{jsonrpc:R,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,s={}){return o()&&e.fork(this.shakeTimeout),N.debug("current request count=>%d",e.getRequestCount()),t=d(t)?s.contentType?t:{jsonrpc:R,...t}:t,e.request(t,{timeout:this.requestTimeout,...s}).then((e=>{if(!d(e)||e.jsonrpc!==R)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return e.connect((()=>{N.debug("DeviceApp messageBuilder connect with SideService")})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{N.debug("DeviceApp messageBuilder disconnect SideService")})),this},start(){return e.listen((()=>{N.debug("SideService messageBuilder start to listen to DeviceApp")})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{N.debug("SideService messageBuilder stop to listen to DeviceApp")})),this}};var e}const J=e("@zos/ble/TransferFile"),_=(F=new J,{onFile(e){return e?(void 0===F||F.inbox.on("newfile",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===F||F.inbox.on("file",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return F.inbox.emit("file"),this},offFile(){return void 0===F||(F.inbox.off("newfile"),F.inbox.off("file")),this},getFile:()=>void 0===F?null:F.inbox.getNextFile(),sendFile(e,t){if(void 0===F)throw new Error("fileTransfer is not available");return F.outbox.enqueueFile(e,t)}});var F;const X=Object.prototype.hasOwnProperty;function H(e,t){return Object.getOwnPropertyNames(t).forEach((function(s){if(!X.call(e,s)){var n=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,n)}})),e}function W({globalData:e={},onCreate:t,onDestroy:s,...n}={}){const i={globalData:e,...n,onCreate(...e){this.messaging=this.globalData.messaging=A(),this.messaging.onCall(this.onCall?.bind(this)).onRequest(this.onRequest?.bind(this)).connect(),_.onFile(this.onReceivedFile?.bind(this));for(let t=0;t<=W.mixins.length-1;t++){const s=W.mixins[t];s.handler.onCreate?.apply(this,e)}t?.apply(this,e)},onDestroy(...e){s?.apply(this,e);for(let t=W.mixins.length-1;t>=0;t--){const s=W.mixins[t];s.handler.onDestroy?.apply(this,e)}this.messaging.offOnCall().offOnRequest().disConnect(),_.offFile()}};return W.handle(i),i}H(W,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:a,...o},args:d})=>{Object.assign(e,o)}))}}),W.init(),W.use((function(e){e.httpRequest=function(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}}));export{W as BaseApp,H as merge};
diff --git a/node_modules/@zeppos/zml/dist/zml-app.js b/node_modules/@zeppos/zml/dist/zml-app.js
index e5c481d..d1c5e50 100644
--- a/node_modules/@zeppos/zml/dist/zml-app.js
+++ b/node_modules/@zeppos/zml/dist/zml-app.js
@@ -1 +1 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let t=null;n()?t=hmApp.getPackageInfo:i()&&(t=e("@zos/app").getPackageInfo),n()?hmUI:i()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:i()&&e("@zos/router").push;let s=null;function n(){return o()&&r()}function i(){return o()&&a()}function r(){return"undefined"!=typeof hmApp}function a(){return"undefined"!=typeof __$$R$$__}function o(){return r()||a()}n()?s=hmBle:i()&&(s=e("@zos/ble"));let h=null;n()?h=DeviceRuntimeCore.HmLogger:i()?h=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger);const d=e("@zos/utils").EventBus,p=e("@zos/timer").setTimeout,u=e("@zos/timer").clearTimeout;function c(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function l(e,t){const s=c(),n=p((()=>{u(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function f(e){return t=function(e){return JSON.stringify(e)}(e),Buffer.from(t,"utf-8");var t}function y(e){return t=g(e),JSON.parse(t);var t}function g(e){return e.toString("utf-8")}function m(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const I=o()?h.getLogger("device-message"):h.getLogger("side-message"),T=void 0;function b(e){switch(e.toLowerCase()){case"json":return 2;case"text":default:return 1;case"bin":return 3;case"empty":return 0}}let k=1e4;function L(){return k++}let w=1e3;function S(){return w++}class B extends d{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const s=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,s]):s}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class v{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new B(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class U extends Error{constructor(e,t){super(t),this.code=e}}class E extends d{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:i=(o()?s:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?s:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new v,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=c(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=p((()=>{this.shakeStatus=4,this.shakeTask.reject(new U(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&u(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return y(e)}json2Buf(e){return f(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:a,port2:o,appId:h,extra:d,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=T){if(t&&I.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,m(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=T){t&&I.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,m(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const a=3518,o=t.byteLength;let h=0;const d=Buffer.alloc(a),p=e||L(),u=S();let c=1;const l=Math.ceil(o/a);function f(){return c++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=o-h,a=Buffer.alloc(0+e);t.copy(a,0,h,h+e),h+=e,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:a,type:s,opCode:1,totalLength:o,contentType:n,dataType:i},{messageType:r});break}t.copy(d,0,h,h+a),h+=a,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:d,type:s,opCode:0,totalLength:o,contentType:n,dataType:i},{messageType:r})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=f(t),a=e||L();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||L();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let u=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(u)}buildPayload(e){const t=66+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.byteLength,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const u=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt8(s);s+=1;const T=t.readUInt8(s);s+=1;const b=t.readUInt16LE(s);s+=2;const k=t.readUInt32LE(s);s+=4;const L=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:a,totalLength:o,payloadLength:h,payloadType:d,opCode:p,contentType:I,dataType:T,timestamp1:u,timestamp2:c,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:m,extra1:b,extra2:k,extra3:L,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new U(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new U(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t})=>{this.response({requestId:e.traceId,contentType:e.contentType,dataType:e.dataType,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();const s=L(),n=c();t=Object.assign({timeout:6e4,contentType:"json",dataType:"json"},t),this.handlers.set(s,(({traceId:e,payload:t,dataType:s})=>{let i;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:i=g(t);break;case 3:default:i=t;break;case 2:i=y(t)}n.resolve(i)})),Buffer.isBuffer(e)?this.sendBuf({requestId:s,buf:e,type:1,contentType:3,dataType:b(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:s,buf:Buffer.from(e),type:1,contentType:3,dataType:b(t.dataType)}):this.sendJson({requestId:s,json:e,type:1,contentType:2,dataType:b(t.dataType)});let i=!1;return Promise.race([l(t.timeout,((e,s)=>{if(i)return e();s(new U(4,`request timed out in ${t.timeout}ms.`))})),n.promise.finally((()=>{i=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(s)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s})}call(e){return this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):this.sendJson({json:e,type:3,contentType:2,dataType:0})))}}h.getLogger("message-builder");const C=e("@zos/ble/TransferFile"),q=(P=new C,{onFile(e){return e?(void 0===P||P.inbox.on("newfile",(function(){const t=P.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===P||P.inbox.on("file",(function(){const t=P.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return P.inbox.emit("file"),this},offFile(){return void 0===P||(P.inbox.off("newfile"),P.inbox.off("file")),this},getFile:()=>void 0===P?null:P.inbox.getNextFile(),sendFile(e,t){if(void 0===P)throw new Error("fileTransfer is not available");return P.outbox.enqueueFile(e,t)}});var P;function D({globalData:e={},onCreate:s,onDestroy:n,...i}={}){return{globalData:e,...i,onCreate(...e){const n=(i=new E({appId:t().appId,appDevicePort:20,appSidePort:0}),{shakeTimeout:5e3,requestTimeout:6e4,onCall(e){return e?(i.on("call",(({payload:t})=>{const s=i.buf2Json(t);e&&e(s)})),this):this},offOnCall(e){return i.off("call",e),this},call(e){return o()&&i.fork(this.shakeTimeout),i.call({jsonrpc:"hmrpcv1",...e})},onRequest(e){return e?(i.on("request",(t=>{const s=i.buf2Json(t.request.payload);e&&e(s,((e,s)=>e?t.response({data:{error:e}}):t.response({data:{result:s}})))})),this):this},cancelAllRequest(){return i.off("response"),this},offOnRequest(e){return i.off("request",e),this},request(e){return o()&&i.fork(this.shakeTimeout),i.request({jsonrpc:"hmrpcv1",...e},{timeout:this.requestTimeout}).then((({error:e,result:t})=>{if(e)throw e;return t}))},connect(){return i.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),i.disConnect((()=>{})),this},start(){return i.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),i.disConnect((()=>{})),this}});var i;this.globalData.messaging=n,n.onCall(this.onCall?.bind(this)).onRequest(this.onRequest?.bind(this)).connect(),q.onFile(this.onReceivedFile?.bind(this)),s?.apply(this,e)},onDestroy(...e){this.globalData.messaging.offOnCall().offOnRequest().disConnect(),q.offFile(),n?.apply(this,e)},httpRequest:e=>messaging.request({method:"http.request",params:e})}}export{D as BaseApp};
+let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{};let t=null;n()?t=hmApp.getPackageInfo:i()&&(t=e("@zos/app").getPackageInfo),n()?hmUI:i()&&e("@zos/ui"),n()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,n()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,n()?hmApp.gotoPage:i()&&e("@zos/router").push;let s=null;function n(){return o()&&r()}function i(){return o()&&a()}function r(){return"undefined"!=typeof hmApp}function a(){return"undefined"!=typeof __$$R$$__}function o(){return r()||a()}function h(e){return e?.constructor===Object}n()?s=hmBle:i()&&(s=e("@zos/ble"));let d=null;n()?d=DeviceRuntimeCore.HmLogger:i()?d=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(d=Logger);const p=e("@zos/utils").EventBus,u=e("@zos/timer").setTimeout,c=e("@zos/timer").clearTimeout;function l(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function f(e,t){const s=l(),n=u((()=>{c(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function y(e){return I(function(e){return JSON.stringify(e)}(e))}function g(e){return t=T(e),JSON.parse(t);var t}function I(e){return Buffer.from(e,"utf-8")}function T(e){return e.toString("utf-8")}function m(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function B(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const b=o()?d.getLogger("device-message"):d.getLogger("side-message"),k=void 0,S="json",w="text",E="bin",L={EMPTY:0,TEXT:1,JSON:2,BIN:3};function U(e){switch(e.toLowerCase()){case S:return L.JSON;case w:return L.TEXT;case E:return L.BIN;case"empty":return L.EMPTY;default:return L.BIN}}let q=1e4;function v(){return q++}let P=1e3;function C(){return P++}class x extends p{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,b.log("Session Created.")}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.length)return void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.length}`));this.tempBuf||(this.tempBuf=Buffer.alloc(e.totalLength));const t=3518*(e.seqId-1);e.payload.copy(this.tempBuf,t),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.length,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.length}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class D{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new x(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class O extends Error{constructor(e,t){super(t),this.code=e}}class N extends p{constructor({appId:e=0,appDevicePort:t=20,appSidePort:n=0,ble:i=(o()?s:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?s:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=t,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new D,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=l(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=u((()=>{this.shakeStatus=4,this.shakeTask.reject(new O(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&c(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return y(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.length>this.chunkSize)throw new Error(`${e.payload.length} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:a,port2:o,appId:h,extra:d,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=k){if(t&&b.warn("[RAW] [S] send size=%d bin=%s",e.length,B(e.buffer)),!this.ble.send(e.buffer,e.length))throw Error("send message error")}sendBinBySide(e,t=k){t&&b.warn("[RAW] [S] send size=%d bin=%s",e.length,B(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const a=3518,o=t.length;let h=0;const d=Buffer.alloc(a),p=e||v(),u=C();let c=1;const l=Math.ceil(o/a);function f(){return c++}for(let e=1;e<=l;e++){if(this.errorIfBleDisconnect(),e===l){const e=o-h,a=Buffer.alloc(0+e);t.copy(a,0,h,h+e),h+=e,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:a,type:s,opCode:1,totalLength:o,contentType:n,dataType:i},{messageType:r});break}t.copy(d,0,h,h+a),h+=a,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:d,type:s,opCode:0,totalLength:o,contentType:n,dataType:i},{messageType:r})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=y(t),a=e||v();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||v();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=I(t),a=e||v();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let u=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(u)}buildPayload(e){const t=66+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.length,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const u=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const I=t.readUInt32LE(s);s+=4;const T=t.readUInt8(s);s+=1;const m=t.readUInt8(s);s+=1;const B=t.readUInt16LE(s);s+=2;const b=t.readUInt32LE(s);s+=4;const k=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:a,totalLength:o,payloadLength:h,payloadType:d,opCode:p,contentType:T,dataType:m,timestamp1:u,timestamp2:c,timestamp3:l,timestamp4:f,timestamp5:y,timestamp6:g,timestamp7:I,extra1:B,extra2:b,extra3:k,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new O(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new O(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?U(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let s=E;"string"==typeof e?s=w:h(e)?s=S:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(s=E);const n={timeout:6e4,contentType:s,dataType:s},i=v(),r=l();t=Object.assign(n,t),this.handlers.set(i,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case L.TEXT:n=T(t);break;case L.BIN:n=t;break;case L.JSON:n=g(t);break;default:n=t}r.resolve(n)})),Buffer.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:L.BIN,dataType:U(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:L.BIN,dataType:U(t.dataType)}):U(t.contentType)===L.JSON?this.sendJson({requestId:i,json:e,type:1,contentType:L.JSON,dataType:U(t.dataType)}):U(t.contentType)===L.TEXT?this.sendText({requestId:i,text:e,type:1,contentType:L.TEXT,dataType:U(t.dataType)}):this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:L.BIN,dataType:U(t.dataType)});let a=!1;return Promise.race([f(t.timeout,((e,s)=>{if(a)return e();s(new O(4,`request timed out in ${t.timeout}ms.`))})),r.promise.finally((()=>{a=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(i)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){L.BIN===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):L.TEXT===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):L.JSON===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:L.BIN})}call(e){let t=L.JSON;return"string"==typeof e?t=L.TEXT:h(e)?t=L.JSON:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=L.BIN),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:L.BIN,dataType:L.EMPTY}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:L.BIN,dataType:L.EMPTY}):t===L.JSON?this.sendJson({json:e,type:3,contentType:L.JSON,dataType:L.EMPTY}):t===L.TEXT?this.sendText({text:e,type:3,contentType:L.TEXT,dataType:L.EMPTY}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:L.BIN,dataType:L.EMPTY})))}}d.getLogger("message-builder");const $=5e3,j=6e4,M="hmrpcv1",R=20,z=0;function J(){return e=new N({appId:t().appId,appDevicePort:R,appSidePort:z}),{shakeTimeout:$,requestTimeout:j,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case L.JSON:s=g(s);break;case L.TEXT:s=T(s);break;case L.BIN:default:s=m(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=h(t)?opts.contentType?t:{jsonrpc:M,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case L.JSON:s=g(s);break;case L.TEXT:s=T(s);break;case L.BIN:default:s=m(s)}t&&t(s,((t,n,i={})=>e.request.contentType===L.JSON&&s?.jsonrpc===M?t?e.response({data:{jsonrpc:M,error:t}}):e.response({data:{jsonrpc:M,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,s={}){return o()&&e.fork(this.shakeTimeout),t=h(t)?s.contentType?t:{jsonrpc:M,...t}:t,e.request(t,{timeout:this.requestTimeout,...s}).then((e=>{if(!h(e)||e.jsonrpc!==M)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}};var e}const _=e("@zos/ble/TransferFile"),A=(F=new _,{onFile(e){return e?(void 0===F||F.inbox.on("newfile",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===F||F.inbox.on("file",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return F.inbox.emit("file"),this},offFile(){return void 0===F||(F.inbox.off("newfile"),F.inbox.off("file")),this},getFile:()=>void 0===F?null:F.inbox.getNextFile(),sendFile(e,t){if(void 0===F)throw new Error("fileTransfer is not available");return F.outbox.enqueueFile(e,t)}});var F;const X=Object.prototype.hasOwnProperty;function H(e,t){return Object.getOwnPropertyNames(t).forEach((function(s){if(!X.call(e,s)){var n=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,n)}})),e}function Y({globalData:e={},onCreate:t,onDestroy:s,...n}={}){const i={globalData:e,...n,onCreate(...e){this.messaging=this.globalData.messaging=J(),this.messaging.onCall(this.onCall?.bind(this)).onRequest(this.onRequest?.bind(this)).connect(),A.onFile(this.onReceivedFile?.bind(this));for(let t=0;t<=Y.mixins.length-1;t++){const s=Y.mixins[t];s.handler.onCreate?.apply(this,e)}t?.apply(this,e)},onDestroy(...e){s?.apply(this,e);for(let t=Y.mixins.length-1;t>=0;t--){const s=Y.mixins[t];s.handler.onDestroy?.apply(this,e)}this.messaging.offOnCall().offOnRequest().disConnect(),A.offFile()}};return Y.handle(i),i}H(Y,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:a,...o},args:h})=>{Object.assign(e,o)}))}}),Y.init(),Y.use((function(e){e.httpRequest=function(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}}));export{Y as BaseApp,H as merge};
diff --git a/node_modules/@zeppos/zml/dist/zml-page.debug.js b/node_modules/@zeppos/zml/dist/zml-page.debug.js
index 5dd6c7f..a40f510 100644
--- a/node_modules/@zeppos/zml/dist/zml-page.debug.js
+++ b/node_modules/@zeppos/zml/dist/zml-page.debug.js
@@ -1 +1 @@
-let e=null;function t(){return s()&&n()}function i(){return s()&&o()}function n(){return"undefined"!=typeof hmApp}function o(){return"undefined"!=typeof __$$R$$__}function s(){return n()||o()}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},t()?hmApp.getPackageInfo:i()&&e("@zos/app").getPackageInfo,t()?hmUI:i()&&e("@zos/ui"),t()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,t()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,t()?hmApp.gotoPage:i()&&e("@zos/router").push,t()?hmBle:i()&&e("@zos/ble");let l=null;t()?l=DeviceRuntimeCore.HmLogger:i()?l=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(l=Logger),e("@zos/utils").EventBus,e("@zos/timer").setTimeout,e("@zos/timer").clearTimeout,s()?l.getLogger("device-message"):l.getLogger("side-message"),l.getLogger("message-builder");const r=e("@zos/ble/TransferFile"),u=(f=new r,{onFile(e){return e?(void 0===f||f.inbox.on("newfile",(function(){const t=f.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===f||f.inbox.on("file",(function(){const t=f.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return f.inbox.emit("file"),this},offFile(){return void 0===f||(f.inbox.off("newfile"),f.inbox.off("file")),this},getFile:()=>void 0===f?null:f.inbox.getNextFile(),sendFile(e,t){if(void 0===f)throw new Error("fileTransfer is not available");return f.outbox.enqueueFile(e,t)}});var f;function g({state:e={},onInit:t,onDestroy:i,...n}={}){const o=function(){const{messaging:e}=getApp()._options.globalData;return e}();return{state:e,...n,onInit(...e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),o.onCall(this._onCall).onRequest(this._onRequest),this.onReceivedFile&&(this._onReceivedFile=this.onReceivedFile?.bind(this),u.onFile(this._onReceivedFile)),t?.apply(this,e)},onDestroy(...e){this._onCall&&o.offOnCall(this._onCall),this._onRequest&&o.offOnRequest(this._onRequest),this._onReceivedFile&&u.offFile(this._onReceivedFile),i?.apply(this,e)},request:e=>o.request(e),httpRequest:e=>o.request({method:"http.request",params:e}),call:e=>o.call(e),sendFile:(e,t)=>u.sendFile(e,t)}}export{g as BasePage};
+let e=null;function t(){return o()&&n()}function i(){return o()&&s()}function n(){return"undefined"!=typeof hmApp}function s(){return"undefined"!=typeof __$$R$$__}function o(){return n()||s()}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},t()?hmApp.getPackageInfo:i()&&e("@zos/app").getPackageInfo,t()?hmUI:i()&&e("@zos/ui"),t()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,t()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,t()?hmApp.gotoPage:i()&&e("@zos/router").push,t()?hmBle:i()&&e("@zos/ble");let l=null;t()?l=DeviceRuntimeCore.HmLogger:i()?l=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(l=Logger),e("@zos/utils").EventBus,e("@zos/timer").setTimeout,e("@zos/timer").clearTimeout,o()?l.getLogger("device-message"):l.getLogger("side-message"),l.getLogger("message-builder");const r=e("@zos/ble/TransferFile"),a=(h=new r,{onFile(e){return e?(void 0===h||h.inbox.on("newfile",(function(){const t=h.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===h||h.inbox.on("file",(function(){const t=h.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return h.inbox.emit("file"),this},offFile(){return void 0===h||(h.inbox.off("newfile"),h.inbox.off("file")),this},getFile:()=>void 0===h?null:h.inbox.getNextFile(),sendFile(e,t){if(void 0===h)throw new Error("fileTransfer is not available");return h.outbox.enqueueFile(e,t)}});var h;const u=Object.prototype.hasOwnProperty;function g(e,t){return Object.getOwnPropertyNames(t).forEach((function(i){if(!u.call(e,i)){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n)}})),e}function f({state:e={},onInit:t,onResume:i,onPause:n,build:s,onDestroy:o,...l}={}){const r=function(){const{messaging:e}=getApp()._options.globalData;return e}(),h={state:e,...l,globalData:getApp()._options.globalData,onInit(...e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging=r,this.messaging.onCall(this._onCall).onRequest(this._onRequest),this.onReceivedFile&&(this._onReceivedFile=this.onReceivedFile?.bind(this),a.onFile(this._onReceivedFile));for(let t=0;t<=f.mixins.length-1;t++){const i=f.mixins[t];i.handler.onInit?.apply(this,e)}t?.apply(this,e)},onResume(...e){for(let t=0;t<=f.mixins.length-1;t++){const i=f.mixins[t];i.handler.onResume?.apply(this,e)}i?.apply(this,e)},onPause(...e){n?.apply(this,e);for(let t=f.mixins.length-1;t>=0;t--){const i=f.mixins[t];i.handler.onPause?.apply(this,e)}},build(...e){for(let t=0;t<=f.mixins.length-1;t++){const i=f.mixins[t];i.handler.build?.apply(this,e)}s?.apply(this,e)},onDestroy(...e){o?.apply(this,e);for(let t=f.mixins.length-1;t>=0;t--){const i=f.mixins[t];i.handler.onDestroy?.apply(this,e)}this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this._onReceivedFile&&a.offFile(this._onReceivedFile)},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},sendFile:(e,t)=>a.sendFile(e,t)};return f.handle(h),h}g(f,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:i,build:n,onResume:s,onDestroy:o,onCreate:l,...r},args:a})=>{Object.assign(e,r)}))}}),f.init(),f.use((function(e){e.httpRequest=function(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}}));export{f as BasePage,g as merge};
diff --git a/node_modules/@zeppos/zml/dist/zml-page.js b/node_modules/@zeppos/zml/dist/zml-page.js
index 5dd6c7f..a40f510 100644
--- a/node_modules/@zeppos/zml/dist/zml-page.js
+++ b/node_modules/@zeppos/zml/dist/zml-page.js
@@ -1 +1 @@
-let e=null;function t(){return s()&&n()}function i(){return s()&&o()}function n(){return"undefined"!=typeof hmApp}function o(){return"undefined"!=typeof __$$R$$__}function s(){return n()||o()}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},t()?hmApp.getPackageInfo:i()&&e("@zos/app").getPackageInfo,t()?hmUI:i()&&e("@zos/ui"),t()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,t()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,t()?hmApp.gotoPage:i()&&e("@zos/router").push,t()?hmBle:i()&&e("@zos/ble");let l=null;t()?l=DeviceRuntimeCore.HmLogger:i()?l=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(l=Logger),e("@zos/utils").EventBus,e("@zos/timer").setTimeout,e("@zos/timer").clearTimeout,s()?l.getLogger("device-message"):l.getLogger("side-message"),l.getLogger("message-builder");const r=e("@zos/ble/TransferFile"),u=(f=new r,{onFile(e){return e?(void 0===f||f.inbox.on("newfile",(function(){const t=f.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===f||f.inbox.on("file",(function(){const t=f.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return f.inbox.emit("file"),this},offFile(){return void 0===f||(f.inbox.off("newfile"),f.inbox.off("file")),this},getFile:()=>void 0===f?null:f.inbox.getNextFile(),sendFile(e,t){if(void 0===f)throw new Error("fileTransfer is not available");return f.outbox.enqueueFile(e,t)}});var f;function g({state:e={},onInit:t,onDestroy:i,...n}={}){const o=function(){const{messaging:e}=getApp()._options.globalData;return e}();return{state:e,...n,onInit(...e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),o.onCall(this._onCall).onRequest(this._onRequest),this.onReceivedFile&&(this._onReceivedFile=this.onReceivedFile?.bind(this),u.onFile(this._onReceivedFile)),t?.apply(this,e)},onDestroy(...e){this._onCall&&o.offOnCall(this._onCall),this._onRequest&&o.offOnRequest(this._onRequest),this._onReceivedFile&&u.offFile(this._onReceivedFile),i?.apply(this,e)},request:e=>o.request(e),httpRequest:e=>o.request({method:"http.request",params:e}),call:e=>o.call(e),sendFile:(e,t)=>u.sendFile(e,t)}}export{g as BasePage};
+let e=null;function t(){return o()&&n()}function i(){return o()&&s()}function n(){return"undefined"!=typeof hmApp}function s(){return"undefined"!=typeof __$$R$$__}function o(){return n()||s()}e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},t()?hmApp.getPackageInfo:i()&&e("@zos/app").getPackageInfo,t()?hmUI:i()&&e("@zos/ui"),t()?hmSetting.getDeviceInfo:i()&&e("@zos/device").getDeviceInfo,t()?"undefined"!=typeof __$$app$$__&&__$$app$$__:i()&&e("@zos/i18n").getText,t()?hmApp.gotoPage:i()&&e("@zos/router").push,t()?hmBle:i()&&e("@zos/ble");let l=null;t()?l=DeviceRuntimeCore.HmLogger:i()?l=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(l=Logger),e("@zos/utils").EventBus,e("@zos/timer").setTimeout,e("@zos/timer").clearTimeout,o()?l.getLogger("device-message"):l.getLogger("side-message"),l.getLogger("message-builder");const r=e("@zos/ble/TransferFile"),a=(h=new r,{onFile(e){return e?(void 0===h||h.inbox.on("newfile",(function(){const t=h.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===h||h.inbox.on("file",(function(){const t=h.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return h.inbox.emit("file"),this},offFile(){return void 0===h||(h.inbox.off("newfile"),h.inbox.off("file")),this},getFile:()=>void 0===h?null:h.inbox.getNextFile(),sendFile(e,t){if(void 0===h)throw new Error("fileTransfer is not available");return h.outbox.enqueueFile(e,t)}});var h;const u=Object.prototype.hasOwnProperty;function g(e,t){return Object.getOwnPropertyNames(t).forEach((function(i){if(!u.call(e,i)){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n)}})),e}function f({state:e={},onInit:t,onResume:i,onPause:n,build:s,onDestroy:o,...l}={}){const r=function(){const{messaging:e}=getApp()._options.globalData;return e}(),h={state:e,...l,globalData:getApp()._options.globalData,onInit(...e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging=r,this.messaging.onCall(this._onCall).onRequest(this._onRequest),this.onReceivedFile&&(this._onReceivedFile=this.onReceivedFile?.bind(this),a.onFile(this._onReceivedFile));for(let t=0;t<=f.mixins.length-1;t++){const i=f.mixins[t];i.handler.onInit?.apply(this,e)}t?.apply(this,e)},onResume(...e){for(let t=0;t<=f.mixins.length-1;t++){const i=f.mixins[t];i.handler.onResume?.apply(this,e)}i?.apply(this,e)},onPause(...e){n?.apply(this,e);for(let t=f.mixins.length-1;t>=0;t--){const i=f.mixins[t];i.handler.onPause?.apply(this,e)}},build(...e){for(let t=0;t<=f.mixins.length-1;t++){const i=f.mixins[t];i.handler.build?.apply(this,e)}s?.apply(this,e)},onDestroy(...e){o?.apply(this,e);for(let t=f.mixins.length-1;t>=0;t--){const i=f.mixins[t];i.handler.onDestroy?.apply(this,e)}this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this._onReceivedFile&&a.offFile(this._onReceivedFile)},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},sendFile:(e,t)=>a.sendFile(e,t)};return f.handle(h),h}g(f,{init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:i,build:n,onResume:s,onDestroy:o,onCreate:l,...r},args:a})=>{Object.assign(e,r)}))}}),f.init(),f.use((function(e){e.httpRequest=function(e,t={}){return this.messaging.request({method:"http.request",params:e},t)}}));export{f as BasePage,g as merge};
diff --git a/node_modules/@zeppos/zml/dist/zml-side.debug.js b/node_modules/@zeppos/zml/dist/zml-side.debug.js
index 7ec0afe..091faea 100644
--- a/node_modules/@zeppos/zml/dist/zml-side.debug.js
+++ b/node_modules/@zeppos/zml/dist/zml-side.debug.js
@@ -1 +1 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},s()?hmApp.getPackageInfo:n()&&e("@zos/app").getPackageInfo,s()?hmUI:n()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:n()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:n()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:n()&&e("@zos/router").push;let t=null;function s(){return o()&&i()}function n(){return o()&&r()}function i(){return"undefined"!=typeof hmApp}function r(){return"undefined"!=typeof __$$R$$__}function o(){return i()||r()}s()?t=hmBle:n()&&(t=e("@zos/ble"));let a=null;s()?a=DeviceRuntimeCore.HmLogger:n()?a=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(a=Logger);class h{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const d=setTimeout,u=clearTimeout;function c(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function l(e,t){const s=c(),n=d((()=>{u(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function p(e){return t=function(e){return JSON.stringify(e)}(e),Buffer.from(t,"utf-8");var t}function f(e){return t=g(e),JSON.parse(t);var t}function g(e){return e.toString("utf-8")}function y(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const m=o()?a.getLogger("device-message"):a.getLogger("side-message");function I(e){switch(e.toLowerCase()){case"json":return 2;case"text":default:return 1;case"bin":return 3;case"empty":return 0}}let b=1e4;function S(){return b++}let L=1e3;function k(){return L++}class T extends h{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.byteLength)return m.error("receive chunk data length error, expect %d but %d",e.payloadLength,e.payload.byteLength),void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`));this.chunks.push(e),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const s=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,s]):s}if(this.finishChunk){if(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength!==this.finishChunk.payloadLength)return m.error("receive full data length error, expect %d but %d",this.finishChunk.payloadLength,this.finishChunk.payload.byteLength),void this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`));this.emit("data",this.finishChunk)}}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class v{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new T(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class w extends Error{constructor(e,t){super(t),this.code=e}}const B=a.getLogger("message-builder"),C=new class extends h{constructor({appId:e=0,appDevicePort:s=20,appSidePort:n=0,ble:i=(o()?t:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?t:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=s,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new v,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=c(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=d((()=>{this.shakeStatus=4,this.shakeTask.reject(new w(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&u(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return f(e)}json2Buf(e){return p(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{m.warn("[RAW] [R] receive index=>%d size=>%d bin=>%s",e,s,y(t)),this.onFragmentData(t)})),e&&e(this)}disConnect(e){m.debug("app ble disconnect"),this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{m.warn("[RAW] [R] receive size=>%d bin=>%s",e.byteLength,y(e)),this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){m.info("shake send");const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){m.info("close send");const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:o,port2:a,appId:h,extra:d,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=!0){if(t&&m.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,y(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=!0){t&&m.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,y(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const o=3518,a=t.byteLength;let h=0;const d=Buffer.alloc(o),u=e||S(),c=k();let l=1;const p=Math.ceil(a/o);function f(){return l++}for(let e=1;e<=p;e++){if(this.errorIfBleDisconnect(),e===p){const e=a-h,o=Buffer.alloc(0+e);t.copy(o,0,h,h+e),h+=e,this.sendDataWithSession({traceId:u,spanId:c,seqId:f(),payload:o,type:s,opCode:1,totalLength:a,contentType:n,dataType:i},{messageType:r});break}t.copy(d,0,h,h+o),h+=o,this.sendDataWithSession({traceId:u,spanId:c,seqId:f(),payload:d,type:s,opCode:0,totalLength:a,contentType:n,dataType:i},{messageType:r})}h===a?m.debug("HmProtocol send ok msgSize=> %d dataSize=> %d",h,a):m.error("HmProtocol send error msgSize=> %d dataSize=> %d",h,a)}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=p(t),o=e||S();this.sendHmProtocol({requestId:o,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||S();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:o,contentType:a,dataType:h},{messageType:d}){const u=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:o,type:i,opCode:r,payload:n,contentType:a,dataType:h});let c=this.isDevice?this.buildData(u,{type:d}):u;this.sendMsg(c)}buildPayload(e){const t=66+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.byteLength,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt8(s);s+=1;const u=t.readUInt8(s);s+=1;const c=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const p=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt8(s);s+=1;const b=t.readUInt8(s);s+=1;const S=t.readUInt16LE(s);s+=2;const L=t.readUInt32LE(s);s+=4;const k=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:o,totalLength:a,payloadLength:h,payloadType:d,opCode:u,contentType:I,dataType:b,timestamp1:c,timestamp2:l,timestamp3:p,timestamp4:f,timestamp5:g,timestamp6:y,timestamp7:m,extra1:S,extra2:L,extra3:k,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),m.debug("receive data=>",JSON.stringify(t)),1===t.flag&&1===t.type?(this.appSidePort=t.port2,m.debug("shake success appSidePort=>",t.port2),this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag?m.debug("receive runtime => flag %d type %d",t.flag,t.type):1===t.flag&&2===t.type?(this.appSidePort=0,m.debug("receive close =>",this.appSidePort)):m.error("error appSidePort=>%d data=>%j",this.appSidePort,t)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new w(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new w(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t})=>{this.response({requestId:e.traceId,contentType:e.contentType,dataType:e.dataType,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();const s=S(),n=c();t=Object.assign({timeout:6e4,contentType:"json",dataType:"json"},t),this.handlers.set(s,(({traceId:t,payload:i,dataType:r})=>{let o;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),m.debug("traceId=>%d payload=>%s",t,i.toString("hex")),r){case 1:o=g(i);break;case 3:default:o=i;break;case 2:o=f(i)}m.debug("request id=>%d payload=>%j",s,e),m.debug("response id=>%d payload=>%j",s,o),n.resolve(o)})),Buffer.isBuffer(e)?this.sendBuf({requestId:s,buf:e,type:1,contentType:3,dataType:I(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:s,buf:Buffer.from(e),type:1,contentType:3,dataType:I(t.dataType)}):this.sendJson({requestId:s,json:e,type:1,contentType:2,dataType:I(t.dataType)});let i=!1;return Promise.race([l(t.timeout,((n,r)=>{if(i)return n();m.error(`request timeout in ${t.timeout}ms error=> %d data=> %j`,s,e),r(new w(4,`request timed out in ${t.timeout}ms.`))})),n.promise.finally((()=>{i=!0}))]).catch((e=>{throw m.error("error %j",e),e})).finally((()=>{this.handlers.delete(s)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s})}call(e){return this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):this.sendJson({json:e,type:3,contentType:2,dataType:0})))}},q=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,onCall(t){return t?(e.on("call",(({payload:s})=>{const n=e.buf2Json(s);t&&t(n)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),e.call({jsonrpc:"hmrpcv1",...t})},onRequest(t){return t?(e.on("request",(s=>{const n=e.buf2Json(s.request.payload);t&&t(n,((e,t)=>e?s.response({data:{error:e}}):s.response({data:{result:t}})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t){return o()&&e.fork(this.shakeTimeout),B.debug("current request count=>%d",e.getRequestCount()),e.request({jsonrpc:"hmrpcv1",...t},{timeout:this.requestTimeout}).then((({error:e,result:t})=>{if(e)throw e;return t}))},connect(){return e.connect((()=>{B.debug("DeviceApp messageBuilder connect with SideService")})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{B.debug("DeviceApp messageBuilder disconnect SideService")})),this},start(){return e.listen((()=>{B.debug("SideService messageBuilder start to listen to DeviceApp")})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{B.debug("SideService messageBuilder stop to listen to DeviceApp")})),this}}}(C),U={onChange(e){return e?(settings.settingsStorage.addListener("change",e),this):this},offChange(){return settings.settingsStorage.removeListener("change"),this},getItem:e=>settings.settingsStorage.getItem(e),setItem:(e,t)=>settings.settingsStorage.setItem(e,t),clear:()=>settings.settingsStorage.clear(),removeItem(e){settings.settingsStorage.removeItem(e)},getAll:()=>settings.settingsStorage.toObject()},E=(R=transferFile,{onFile(e){return e?(void 0===R||R.inbox.on("newfile",(function(){const t=R.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===R||R.inbox.on("file",(function(){const t=R.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return R.inbox.emit("file"),this},offFile(){return void 0===R||(R.inbox.off("newfile"),R.inbox.off("file")),this},getFile:()=>void 0===R?null:R.inbox.getNextFile(),sendFile(e,t){if(void 0===R)throw new Error("fileTransfer is not available");return R.outbox.enqueueFile(e,t)}});var R;const P=Logger.getLogger(sideService.appInfo.app.appName);function _({state:e={},onInit:t,onRun:s,onDestroy:n,...i}={}){return{state:e,...i,onInit(e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),q.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this._onReceivedFile=this.onReceivedFile?.bind(this),E.onSideServiceFileFinished(this._onReceivedFile),this._onSettingsChange=this.onSettingsChange?.bind(this),U.onChange(this._onSettingsChange),q.start(),t?.apply(this,e),Object.entries(i).forEach((([t,s])=>{"string"==typeof t&&t.startsWith("onInit")&&s.apply(this,e)})),"undefined"!=typeof sideService&&(P.log("sideService start launchArgs=>",sideService.launchArgs),sideService.launchReasons.settingsChanged&&this._onSettingsChange(sideService.launchArgs),sideService.launchReasons.fileTransfer&&E.emitFile())},onRun(e){s?.apply(this,e),Object.entries(i).forEach((([t,s])=>{"string"==typeof t&&t.startsWith("onRun")&&s.apply(this,e)}))},onDestroy(e){this._onCall&&q.offOnCall(this._onCall),this._onRequest&&q.offOnRequest(this._onRequest),q.stop(),this._onReceivedFile&&E.offFile(this._onReceivedFile),this._onSettingsChange&&U.offChange(this._onSettingsChange),Object.entries(i).forEach((([t,s])=>{"string"==typeof t&&t.startsWith("onDestroy")&&s.apply(this,e)})),n?.apply(this,e)},request:e=>q.request(e),call:e=>q.call(e),fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.url=new URL(e.url,t.baseURL).toString(),t}(e)),sendFile:(e,t)=>E.sendFile(e,t),download:(e,t={})=>((e,t)=>network.downloader.downloadFile({url:e,...t}))(e,t),__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}}const x={convert:e=>image.convert(e)};export{_ as BaseSideService,x as convertLib,U as settingsLib};
+let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},s()?hmApp.getPackageInfo:n()&&e("@zos/app").getPackageInfo,s()?hmUI:n()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:n()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:n()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:n()&&e("@zos/router").push;let t=null;function s(){return o()&&i()}function n(){return o()&&r()}function i(){return"undefined"!=typeof hmApp}function r(){return"undefined"!=typeof __$$R$$__}function o(){return i()||r()}function a(e){return e?.constructor===Object}s()?t=hmBle:n()&&(t=e("@zos/ble"));let h=null;s()?h=DeviceRuntimeCore.HmLogger:n()?h=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger);class d{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const p=setTimeout,u=clearTimeout;function l(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function c(e,t){const s=l(),n=p((()=>{u(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function f(e){return y(function(e){return JSON.stringify(e)}(e))}function g(e){return t=m(e),JSON.parse(t);var t}function y(e){return Buffer.from(e,"utf-8")}function m(e){return e.toString("utf-8")}function I(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function T(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const S=o()?h.getLogger("device-message"):h.getLogger("side-message"),b="json",k="text",w="bin";function v(e){switch(e.toLowerCase()){case b:return 2;case k:return 1;case w:return 3;case"empty":return 0;default:return 3}}let B=1e4;function L(){return B++}let q=1e3;function C(){return q++}class U extends d{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,S.log("Session Created.")}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.length)return S.error("receive chunk data length error, expect %d but %d",e.payloadLength,e.payload.length),void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.length}`));this.tempBuf||(this.tempBuf=Buffer.alloc(e.totalLength));const t=3518*(e.seqId-1);e.payload.copy(this.tempBuf,t),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){if(this.finishChunk){if(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.length,this.finishChunk.totalLength!==this.finishChunk.payloadLength)return S.error("receive full data length error, expect %d but %d",this.finishChunk.payloadLength,this.finishChunk.payload.length),void this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.length}`));this.emit("data",this.finishChunk)}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class x{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new U(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class E extends Error{constructor(e,t){super(t),this.code=e}}const P=h.getLogger("message-builder"),R="hmrpcv1",_=new class extends d{constructor({appId:e=0,appDevicePort:s=20,appSidePort:n=0,ble:i=(o()?t:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?t:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=s,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new x,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=l(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=p((()=>{this.shakeStatus=4,this.shakeTask.reject(new E(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&u(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return f(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{S.warn("[RAW] [R] receive index=>%d size=>%d bin=>%s",e,s,T(t)),this.onFragmentData(t)})),e&&e(this)}disConnect(e){S.debug("app ble disconnect"),this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{S.warn("[RAW] [R] receive size=>%d bin=>%s",e.length,T(e)),this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.length>this.chunkSize)throw new Error(`${e.payload.length} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){S.info("shake send");const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){S.info("close send");const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:o,port2:a,appId:h,extra:d,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=!0){if(t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,T(e.buffer)),!this.ble.send(e.buffer,e.length))throw Error("send message error")}sendBinBySide(e,t=!0){t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,T(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const o=3518,a=t.length;let h=0;const d=Buffer.alloc(o),p=e||L(),u=C();let l=1;const c=Math.ceil(a/o);function f(){return l++}for(let e=1;e<=c;e++){if(this.errorIfBleDisconnect(),e===c){const e=a-h,o=Buffer.alloc(0+e);t.copy(o,0,h,h+e),h+=e,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:o,type:s,opCode:1,totalLength:a,contentType:n,dataType:i},{messageType:r});break}t.copy(d,0,h,h+o),h+=o,this.sendDataWithSession({traceId:p,spanId:u,seqId:f(),payload:d,type:s,opCode:0,totalLength:a,contentType:n,dataType:i},{messageType:r})}h===a?S.debug("HmProtocol send ok msgSize=> %d dataSize=> %d",h,a):S.error("HmProtocol send error msgSize=> %d dataSize=> %d",h,a)}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=f(t),o=e||L();this.sendHmProtocol({requestId:o,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||L();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=y(t),o=e||L();return this.sendHmProtocol({requestId:o,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:o,contentType:a,dataType:h},{messageType:d}){const p=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:o,type:i,opCode:r,payload:n,contentType:a,dataType:h});let u=this.isDevice?this.buildData(p,{type:d}):p;this.sendMsg(u)}buildPayload(e){const t=66+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.length,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt8(s);s+=1;const p=t.readUInt8(s);s+=1;const u=t.readUInt32LE(s);s+=4;const l=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt8(s);s+=1;const T=t.readUInt8(s);s+=1;const S=t.readUInt16LE(s);s+=2;const b=t.readUInt32LE(s);s+=4;const k=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:o,totalLength:a,payloadLength:h,payloadType:d,opCode:p,contentType:I,dataType:T,timestamp1:u,timestamp2:l,timestamp3:c,timestamp4:f,timestamp5:g,timestamp6:y,timestamp7:m,extra1:S,extra2:b,extra3:k,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),S.debug("receive data=>",JSON.stringify(t)),1===t.flag&&1===t.type?(this.appSidePort=t.port2,S.debug("shake success appSidePort=>",t.port2),this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag?S.debug("receive runtime => flag %d type %d",t.flag,t.type):1===t.flag&&2===t.type?(this.appSidePort=0,S.debug("receive close =>",this.appSidePort)):S.error("error appSidePort=>%d data=>%j",this.appSidePort,t)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new E(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new E(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?v(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let s=w;"string"==typeof e?s=k:a(e)?s=b:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(s=w);const n={timeout:6e4,contentType:s,dataType:s},i=L(),r=l();t=Object.assign(n,t),this.handlers.set(i,(({traceId:t,payload:s,dataType:n})=>{let o;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),S.debug("traceId=>%d payload=>%s",t,s.toString("hex")),n){case 1:o=m(s);break;case 3:default:o=s;break;case 2:o=g(s)}S.debug("request id=>%d payload=>%j",i,e),S.debug("response id=>%d payload=>%j",i,o),r.resolve(o)})),Buffer.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:3,dataType:v(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:3,dataType:v(t.dataType)}):2===v(t.contentType)?this.sendJson({requestId:i,json:e,type:1,contentType:2,dataType:v(t.dataType)}):1===v(t.contentType)?this.sendText({requestId:i,text:e,type:1,contentType:1,dataType:v(t.dataType)}):this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:3,dataType:v(t.dataType)});let o=!1;return Promise.race([c(t.timeout,((s,n)=>{if(o)return s();S.error(`request timeout in ${t.timeout}ms error=> %d data=> %j`,i,e),n(new E(4,`request timed out in ${t.timeout}ms.`))})),r.promise.finally((()=>{o=!0}))]).catch((e=>{throw S.error("error %j",e),e})).finally((()=>{this.handlers.delete(i)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:a(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0})))}},D=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case 2:s=g(s);break;case 1:s=m(s);break;default:s=I(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),t=a(t)?opts.contentType?t:{jsonrpc:R,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case 2:s=g(s);break;case 1:s=m(s);break;default:s=I(s)}t&&t(s,((t,n,i={})=>2===e.request.contentType&&s?.jsonrpc===R?t?e.response({data:{jsonrpc:R,error:t}}):e.response({data:{jsonrpc:R,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,s={}){return o()&&e.fork(this.shakeTimeout),P.debug("current request count=>%d",e.getRequestCount()),t=a(t)?s.contentType?t:{jsonrpc:R,...t}:t,e.request(t,{timeout:this.requestTimeout,...s}).then((e=>{if(!a(e)||e.jsonrpc!==R)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return e.connect((()=>{P.debug("DeviceApp messageBuilder connect with SideService")})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{P.debug("DeviceApp messageBuilder disconnect SideService")})),this},start(){return e.listen((()=>{P.debug("SideService messageBuilder start to listen to DeviceApp")})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{P.debug("SideService messageBuilder stop to listen to DeviceApp")})),this}}}(_),j={onChange(e){return e?(settings.settingsStorage.addListener("change",e),this):this},offChange(){return settings.settingsStorage.removeListener("change"),this},getItem:e=>settings.settingsStorage.getItem(e),setItem:(e,t)=>settings.settingsStorage.setItem(e,t),clear:()=>settings.settingsStorage.clear(),removeItem(e){settings.settingsStorage.removeItem(e)},getAll:()=>settings.settingsStorage.toObject()},$=(A=transferFile,{onFile(e){return e?(void 0===A||A.inbox.on("newfile",(function(){const t=A.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===A||A.inbox.on("file",(function(){const t=A.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return A.inbox.emit("file"),this},offFile(){return void 0===A||(A.inbox.off("newfile"),A.inbox.off("file")),this},getFile:()=>void 0===A?null:A.inbox.getNextFile(),sendFile(e,t){if(void 0===A)throw new Error("fileTransfer is not available");return A.outbox.enqueueFile(e,t)}});var A;const F=Object.prototype.hasOwnProperty,z={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:o,...a},args:h})=>{Object.assign(e,a)}))}},O=Logger.getLogger(sideService.appInfo.app.appName);function M({state:e={},onInit:t,onRun:s,onDestroy:n,...i}={}){const r={state:e,...i,onInit(e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging=D,this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this._onReceivedFile=this.onReceivedFile?.bind(this),$.onSideServiceFileFinished(this._onReceivedFile),this._onSettingsChange=this.onSettingsChange?.bind(this),j.onChange(this._onSettingsChange),this.messaging.start();for(let t=0;t<=M.mixins.length-1;t++){const s=M.mixins[t];s.handler.onInit?.apply(this,e)}t?.apply(this,e),"undefined"!=typeof sideService&&(O.log("sideService start launchArgs=>",sideService.launchArgs),sideService.launchReasons.settingsChanged&&this._onSettingsChange(sideService.launchArgs),sideService.launchReasons.fileTransfer&&$.emitFile())},onRun(e){for(let t=0;t<=M.mixins.length-1;t++){const s=M.mixins[t];s.handler.onRun?.apply(this,e)}s?.apply(this,e)},onDestroy(e){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop(),this._onReceivedFile&&$.offFile(this._onReceivedFile),this._onSettingsChange&&j.offChange(this._onSettingsChange),n?.apply(this,e);for(let t=M.mixins.length-1;t>=0;t--){const s=M.mixins[t];s.handler.onDestroy?.apply(this,e)}},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.url=new URL(e.url,t.baseURL).toString(),t}(e)),sendFile:(e,t)=>$.sendFile(e,t),download:(e,t={})=>((e,t)=>network.downloader.downloadFile({url:e,...t}))(e,t),__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}};return M.handle(r),r}var H,J;H=M,J=z,Object.getOwnPropertyNames(J).forEach((function(e){if(!F.call(H,e)){var t=Object.getOwnPropertyDescriptor(J,e);Object.defineProperty(H,e,t)}})),M.init();const N={convert:e=>image.convert(e)};export{M as BaseSideService,N as convertLib,j as settingsLib};
diff --git a/node_modules/@zeppos/zml/dist/zml-side.js b/node_modules/@zeppos/zml/dist/zml-side.js
index 6a382d1..ee8084a 100644
--- a/node_modules/@zeppos/zml/dist/zml-side.js
+++ b/node_modules/@zeppos/zml/dist/zml-side.js
@@ -1 +1 @@
-let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},s()?hmApp.getPackageInfo:n()&&e("@zos/app").getPackageInfo,s()?hmUI:n()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:n()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:n()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:n()&&e("@zos/router").push;let t=null;function s(){return o()&&i()}function n(){return o()&&r()}function i(){return"undefined"!=typeof hmApp}function r(){return"undefined"!=typeof __$$R$$__}function o(){return i()||r()}s()?t=hmBle:n()&&(t=e("@zos/ble"));let a=null;s()?a=DeviceRuntimeCore.HmLogger:n()?a=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(a=Logger);class h{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const d=setTimeout,l=clearTimeout;function u(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function c(e,t){const s=u(),n=d((()=>{l(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function p(e){return t=function(e){return JSON.stringify(e)}(e),Buffer.from(t,"utf-8");var t}function f(e){return t=g(e),JSON.parse(t);var t}function g(e){return e.toString("utf-8")}function y(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const m=o()?a.getLogger("device-message"):a.getLogger("side-message"),I=void 0;function b(e){switch(e.toLowerCase()){case"json":return 2;case"text":default:return 1;case"bin":return 3;case"empty":return 0}}let T=1e4;function S(){return T++}let L=1e3;function k(){return L++}class w extends h{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.chunks=[],this.count=0,this.finishChunk=null}addChunk(e){1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength===e.payload.byteLength?(this.chunks.push(e),this.checkIfReceiveAllChunks()):this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.byteLength}`))}checkIfReceiveAllChunks(){if(this.count===this.chunks.length){for(let e=1;e<=this.count;e++){const t=this.chunks.find((t=>t.seqId===e));if(!t)return this.releaseBuf(),void this.emit("error",Error("receive data error"));const s=t.payload;this.tempBuf=this.tempBuf?Buffer.concat([this.tempBuf,s]):s}this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.byteLength,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.byteLength}`)))}}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.chunks=[],this.finishChunk=null,this.count=0}}class v{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new w(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class B extends Error{constructor(e,t){super(t),this.code=e}}a.getLogger("message-builder");const C=new class extends h{constructor({appId:e=0,appDevicePort:s=20,appSidePort:n=0,ble:i=(o()?t:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:o()?t:void 0}){super(),this.isDevice=o(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=s,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new v,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=u(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=d((()=>{this.shakeStatus=4,this.shakeTask.reject(new B(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&l(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return f(e)}json2Buf(e){return p(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.byteLength>this.chunkSize)throw new Error(`${e.payload.byteLength} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:o,port2:a,appId:h,extra:d,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=I){if(t&&m.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,y(e.buffer)),!this.ble.send(e.buffer,e.byteLength))throw Error("send message error")}sendBinBySide(e,t=I){t&&m.warn("[RAW] [S] send size=%d bin=%s",e.byteLength,y(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const o=3518,a=t.byteLength;let h=0;const d=Buffer.alloc(o),l=e||S(),u=k();let c=1;const p=Math.ceil(a/o);function f(){return c++}for(let e=1;e<=p;e++){if(this.errorIfBleDisconnect(),e===p){const e=a-h,o=Buffer.alloc(0+e);t.copy(o,0,h,h+e),h+=e,this.sendDataWithSession({traceId:l,spanId:u,seqId:f(),payload:o,type:s,opCode:1,totalLength:a,contentType:n,dataType:i},{messageType:r});break}t.copy(d,0,h,h+o),h+=o,this.sendDataWithSession({traceId:l,spanId:u,seqId:f(),payload:d,type:s,opCode:0,totalLength:a,contentType:n,dataType:i},{messageType:r})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=p(t),o=e||S();this.sendHmProtocol({requestId:o,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||S();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:o,contentType:a,dataType:h},{messageType:d}){const l=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:o,type:i,opCode:r,payload:n,contentType:a,dataType:h});let u=this.isDevice?this.buildData(l,{type:d}):l;this.sendMsg(u)}buildPayload(e){const t=66+e.payload.byteLength;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.byteLength,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.byteLength+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt8(s);s+=1;const l=t.readUInt8(s);s+=1;const u=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const p=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt8(s);s+=1;const b=t.readUInt8(s);s+=1;const T=t.readUInt16LE(s);s+=2;const S=t.readUInt32LE(s);s+=4;const L=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:o,totalLength:a,payloadLength:h,payloadType:d,opCode:l,contentType:I,dataType:b,timestamp1:u,timestamp2:c,timestamp3:p,timestamp4:f,timestamp5:g,timestamp6:y,timestamp7:m,extra1:T,extra2:S,extra3:L,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(o()&&!this.ble.connectStatus())throw new B(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(o&&!this.appSidePort)throw new B(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t})=>{this.response({requestId:e.traceId,contentType:e.contentType,dataType:e.dataType,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();const s=S(),n=u();t=Object.assign({timeout:6e4,contentType:"json",dataType:"json"},t),this.handlers.set(s,(({traceId:e,payload:t,dataType:s})=>{let i;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:i=g(t);break;case 3:default:i=t;break;case 2:i=f(t)}n.resolve(i)})),Buffer.isBuffer(e)?this.sendBuf({requestId:s,buf:e,type:1,contentType:3,dataType:b(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:s,buf:Buffer.from(e),type:1,contentType:3,dataType:b(t.dataType)}):this.sendJson({requestId:s,json:e,type:1,contentType:2,dataType:b(t.dataType)});let i=!1;return Promise.race([c(t.timeout,((e,s)=>{if(i)return e();s(new B(4,`request timed out in ${t.timeout}ms.`))})),n.promise.finally((()=>{i=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(s)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s})}call(e){return this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):this.sendJson({json:e,type:3,contentType:2,dataType:0})))}},U=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,onCall(t){return t?(e.on("call",(({payload:s})=>{const n=e.buf2Json(s);t&&t(n)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return o()&&e.fork(this.shakeTimeout),e.call({jsonrpc:"hmrpcv1",...t})},onRequest(t){return t?(e.on("request",(s=>{const n=e.buf2Json(s.request.payload);t&&t(n,((e,t)=>e?s.response({data:{error:e}}):s.response({data:{result:t}})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t){return o()&&e.fork(this.shakeTimeout),e.request({jsonrpc:"hmrpcv1",...t},{timeout:this.requestTimeout}).then((({error:e,result:t})=>{if(e)throw e;return t}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}(C),q={onChange(e){return e?(settings.settingsStorage.addListener("change",e),this):this},offChange(){return settings.settingsStorage.removeListener("change"),this},getItem:e=>settings.settingsStorage.getItem(e),setItem:(e,t)=>settings.settingsStorage.setItem(e,t),clear:()=>settings.settingsStorage.clear(),removeItem(e){settings.settingsStorage.removeItem(e)},getAll:()=>settings.settingsStorage.toObject()},E=(R=transferFile,{onFile(e){return e?(void 0===R||R.inbox.on("newfile",(function(){const t=R.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===R||R.inbox.on("file",(function(){const t=R.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return R.inbox.emit("file"),this},offFile(){return void 0===R||(R.inbox.off("newfile"),R.inbox.off("file")),this},getFile:()=>void 0===R?null:R.inbox.getNextFile(),sendFile(e,t){if(void 0===R)throw new Error("fileTransfer is not available");return R.outbox.enqueueFile(e,t)}});var R;function _({state:e={},onInit:t,onRun:s,onDestroy:n,...i}={}){return{state:e,...i,onInit(e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),U.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this._onReceivedFile=this.onReceivedFile?.bind(this),E.onSideServiceFileFinished(this._onReceivedFile),this._onSettingsChange=this.onSettingsChange?.bind(this),q.onChange(this._onSettingsChange),U.start(),t?.apply(this,e),Object.entries(i).forEach((([t,s])=>{"string"==typeof t&&t.startsWith("onInit")&&s.apply(this,e)})),"undefined"!=typeof sideService&&(sideService.launchReasons.settingsChanged&&this._onSettingsChange(sideService.launchArgs),sideService.launchReasons.fileTransfer&&E.emitFile())},onRun(e){s?.apply(this,e),Object.entries(i).forEach((([t,s])=>{"string"==typeof t&&t.startsWith("onRun")&&s.apply(this,e)}))},onDestroy(e){this._onCall&&U.offOnCall(this._onCall),this._onRequest&&U.offOnRequest(this._onRequest),U.stop(),this._onReceivedFile&&E.offFile(this._onReceivedFile),this._onSettingsChange&&q.offChange(this._onSettingsChange),Object.entries(i).forEach((([t,s])=>{"string"==typeof t&&t.startsWith("onDestroy")&&s.apply(this,e)})),n?.apply(this,e)},request:e=>U.request(e),call:e=>U.call(e),fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.url=new URL(e.url,t.baseURL).toString(),t}(e)),sendFile:(e,t)=>E.sendFile(e,t),download:(e,t={})=>((e,t)=>network.downloader.downloadFile({url:e,...t}))(e,t),__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}}}Logger.getLogger(sideService.appInfo.app.appName);const P={convert:e=>image.convert(e)};export{_ as BaseSideService,P as convertLib,q as settingsLib};
+let e=null;e="undefined"!=typeof __$$R$$__?__$$R$$__:()=>{},s()?hmApp.getPackageInfo:n()&&e("@zos/app").getPackageInfo,s()?hmUI:n()&&e("@zos/ui"),s()?hmSetting.getDeviceInfo:n()&&e("@zos/device").getDeviceInfo,s()?"undefined"!=typeof __$$app$$__&&__$$app$$__:n()&&e("@zos/i18n").getText,s()?hmApp.gotoPage:n()&&e("@zos/router").push;let t=null;function s(){return a()&&i()}function n(){return a()&&r()}function i(){return"undefined"!=typeof hmApp}function r(){return"undefined"!=typeof __$$R$$__}function a(){return i()||r()}function o(e){return e?.constructor===Object}s()?t=hmBle:n()&&(t=e("@zos/ble"));let h=null;s()?h=DeviceRuntimeCore.HmLogger:n()?h=e("@zos/utils").log:"undefined"!=typeof messaging&&"undefined"!=typeof Logger&&(h=Logger);class d{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(e)if(t){const s=this.listeners.get(e);if(!s)return;const n=s.findIndex((e=>e===t));n>=0&&s.splice(n,1)}else this.listeners.delete(e)}emit(e,...t){for(let s of this.listeners.get(e)??[])s&&s(...t)}clear(){this.listeners.clear()}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}count(e){return(this.listeners.get(e)??[]).length}}const l=setTimeout,p=clearTimeout;function u(){const e={canceled:!1};return e.promise=new Promise((function(t,s){e.resolve=t,e.reject=s})),e.cancel=()=>{e.canceled=!0,e.reject(new Error("Task canceled"))},e}function c(e,t){const s=u(),n=l((()=>{p(n),t?t&&t(s.resolve,s.reject):s.reject("Timed out in "+e+"ms.")}),e=e||1e3);return s.promise}function f(e){return y(function(e){return JSON.stringify(e)}(e))}function g(e){return t=m(e),JSON.parse(t);var t}function y(e){return Buffer.from(e,"utf-8")}function m(e){return e.toString("utf-8")}function I(e){return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function T(e){return t=function(e){return Buffer.from(e)}(e),t.toString("hex");var t}const S=a()?h.getLogger("device-message"):h.getLogger("side-message"),b=void 0,k="json",w="text",B="bin";function L(e){switch(e.toLowerCase()){case k:return 2;case w:return 1;case B:return 3;case"empty":return 0;default:return 3}}let v=1e4;function q(){return v++}let C=1e3;function U(){return C++}class E extends d{constructor(e,t,s){super(),this.id=e,this.type=t,this.ctx=s,this.tempBuf=null,this.count=0,this.finishChunk=null,S.log("Session Created.")}addChunk(e){if(1===e.opCode&&(this.count=e.seqId,this.finishChunk=e),e.payloadLength!==e.payload.length)return void this.emit("error",Error(`receive chunk data length error, expect ${e.payloadLength} but ${e.payload.length}`));this.tempBuf||(this.tempBuf=Buffer.alloc(e.totalLength));const t=3518*(e.seqId-1);e.payload.copy(this.tempBuf,t),this.checkIfReceiveAllChunks()}checkIfReceiveAllChunks(){this.finishChunk&&(this.finishChunk.payload=this.tempBuf,this.finishChunk.payloadLength=this.finishChunk.payload.length,this.finishChunk.totalLength===this.finishChunk.payloadLength?this.emit("data",this.finishChunk):this.emit("error",Error(`receive full data length error, expect ${this.finishChunk.payloadLength} but ${this.finishChunk.payload.length}`)))}getLength(){return this.tempBufLength}releaseBuf(){this.tempBuf=null,this.finishChunk=null,this.count=0}}class x{constructor(){this.sessions=new Map}key(e){return`${e.id}:${e.type}`}newSession(e,t,s){const n=new E(e,t,s);return this.sessions.set(this.key(n),n),n}destroy(e){e.releaseBuf(),this.sessions.delete(this.key(e))}has(e,t){return this.sessions.has(this.key({id:e,type:t}))}getById(e,t){return this.sessions.get(this.key({id:e,type:t}))}clear(){this.sessions.clear()}}class P extends Error{constructor(e,t){super(t),this.code=e}}h.getLogger("message-builder");const R="hmrpcv1",_=new class extends d{constructor({appId:e=0,appDevicePort:s=20,appSidePort:n=0,ble:i=(a()?t:void 0)}={appId:0,appDevicePort:20,appSidePort:0,ble:a()?t:void 0}){super(),this.isDevice=a(),this.isSide=!this.isDevice,this.appId=e,this.appDevicePort=s,this.appSidePort=n,this.ble=i,this.sendMsg=this.getSafeSend(),this.chunkSize=3584,this.tempBuf=null,this.handlers=new Map,this.shakeTask=null,this.waitingShakePromise=null,this.shakeStatus=1,this.shakeTimer=0,this.sessionMgr=new x,this.on("response",(e=>{this.onResponse(e)}))}fork(e=5e3){return 2===this.shakeStatus||(this.shakeTask=u(),this.waitingShakePromise=this.shakeTask.promise,this.shakeStatus=1,this.clearShakeTimer(),this.shakeTimer=l((()=>{this.shakeStatus=4,this.shakeTask.reject(new P(1,"shake timeout"))}),e),this.shakeStatus=2,this.sendShake()),this.waitingShakePromise}clearShakeTimer(){this.shakeTimer&&p(this.shakeTimer),this.shakeTimer=0}getMessageSize(){return 3600}getMessagePayloadSize(){return 3584}getMessageHeaderSize(){return 16}buf2Json(e){return g(e)}json2Buf(e){return f(e)}now(e=Date.now()){return function(e=Date.now()){return e%1e7}(e)}connect(e){this.on("message",(e=>{this.onMessage(e)})),this.ble&&this.ble.createConnect(((e,t,s)=>{this.onFragmentData(t)})),e&&e(this)}disConnect(e){this.sendClose(),this.off("message"),this.handlers.clear(),this.ble&&this.ble.disConnect(),e&&e(this)}listen(e){this.appSidePort=globalThis.getApp().port2,messaging&&messaging.peerSocket.addListener("message",(e=>{this.onMessage(e)})),this.waitingShakePromise=Promise.resolve(),e&&e(this)}buildBin(e){if(e.payload.length>this.chunkSize)throw new Error(`${e.payload.length} greater than max size of ${this.chunkSize}`);const t=this.getMessageHeaderSize()+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt8(e.flag,n),n+=1,s.writeUInt8(e.version,n),n+=1,s.writeUInt16LE(e.type,n),n+=2,s.writeUInt16LE(e.port1,n),n+=2,s.writeUInt16LE(e.port2,n),n+=2,s.writeUInt32LE(e.appId,n),n+=4,s.writeUInt32LE(e.extra,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}buildShake(){return this.buildBin({flag:1,version:1,type:1,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendShake(){const e=this.buildShake();this.sendMsg(e)}buildClose(){return this.buildBin({flag:1,version:1,type:2,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,payload:Buffer.from([this.appId])})}sendClose(){const e=this.buildClose();this.sendMsg(e)}readBin(e){const t=Buffer.from(e);let s=0;const n=t.readUInt8(s);s+=1;const i=t.readUInt8(s);s+=1;const r=t.readUInt16LE(s);s+=2;const a=t.readUInt16LE(s);s+=2;const o=t.readUInt16LE(s);s+=2;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt32LE(s);return s+=4,{flag:n,version:i,type:r,port1:a,port2:o,appId:h,extra:d,payload:t.subarray(s)}}buildData(e,t={}){return this.buildBin({flag:1,version:1,type:4,port1:this.appDevicePort,port2:this.appSidePort,appId:this.appId,extra:0,...t,payload:e})}sendBin(e,t=b){if(t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,T(e.buffer)),!this.ble.send(e.buffer,e.length))throw Error("send message error")}sendBinBySide(e,t=b){t&&S.warn("[RAW] [S] send size=%d bin=%s",e.length,T(e.buffer)),messaging.peerSocket.send(e.buffer)}getSafeSend(){return this.isDevice?this.sendBin.bind(this):this.sendBinBySide.bind(this)}sendHmProtocol({requestId:e,dataBin:t,type:s,contentType:n,dataType:i},{messageType:r=4}={}){const a=3518,o=t.length;let h=0;const d=Buffer.alloc(a),l=e||q(),p=U();let u=1;const c=Math.ceil(o/a);function f(){return u++}for(let e=1;e<=c;e++){if(this.errorIfBleDisconnect(),e===c){const e=o-h,a=Buffer.alloc(0+e);t.copy(a,0,h,h+e),h+=e,this.sendDataWithSession({traceId:l,spanId:p,seqId:f(),payload:a,type:s,opCode:1,totalLength:o,contentType:n,dataType:i},{messageType:r});break}t.copy(d,0,h,h+a),h+=a,this.sendDataWithSession({traceId:l,spanId:p,seqId:f(),payload:d,type:s,opCode:0,totalLength:o,contentType:n,dataType:i},{messageType:r})}}sendJson({requestId:e=0,json:t,type:s=1,contentType:n,dataType:i}){const r=f(t),a=e||q();this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendBuf({requestId:e=0,buf:t,type:s=1,contentType:n,dataType:i}){const r=e||q();return this.sendHmProtocol({requestId:r,dataBin:t,type:s,contentType:n,dataType:i})}sendText({requestId:e=0,text:t,type:s=1,contentType:n,dataType:i}){const r=y(t),a=e||q();return this.sendHmProtocol({requestId:a,dataBin:r,type:s,contentType:n,dataType:i})}sendDataWithSession({traceId:e,spanId:t,seqId:s,payload:n,type:i,opCode:r,totalLength:a,contentType:o,dataType:h},{messageType:d}){const l=this.buildPayload({traceId:e,spanId:t,seqId:s,totalLength:a,type:i,opCode:r,payload:n,contentType:o,dataType:h});let p=this.isDevice?this.buildData(l,{type:d}):l;this.sendMsg(p)}buildPayload(e){const t=66+e.payload.length;let s=Buffer.alloc(t),n=0;return s.writeUInt32LE(e.traceId,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(e.spanId,n),n+=4,s.writeUInt32LE(e.seqId,n),n+=4,s.writeUInt32LE(e.totalLength,n),n+=4,s.writeUInt32LE(e.payload.length,n),n+=4,s.writeUInt8(e.type,n),n+=1,s.writeUInt8(e.opCode,n),n+=1,s.writeUInt32LE(this.now(),n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.writeUInt8(e.contentType,n),n+=1,s.writeUInt8(e.dataType,n),n+=1,s.writeUInt16LE(0,n),n+=2,s.writeUInt32LE(0,n),n+=4,s.writeUInt32LE(0,n),n+=4,s.fill(e.payload,n,e.payload.length+n),s}readPayload(e){const t=Buffer.from(e);let s=0;const n=t.readUInt32LE(s);s+=4;const i=t.readUInt32LE(s);s+=4;const r=t.readUInt32LE(s);s+=4;const a=t.readUInt32LE(s);s+=4;const o=t.readUInt32LE(s);s+=4;const h=t.readUInt32LE(s);s+=4;const d=t.readUInt8(s);s+=1;const l=t.readUInt8(s);s+=1;const p=t.readUInt32LE(s);s+=4;const u=t.readUInt32LE(s);s+=4;const c=t.readUInt32LE(s);s+=4;const f=t.readUInt32LE(s);s+=4;const g=t.readUInt32LE(s);s+=4;const y=t.readUInt32LE(s);s+=4;const m=t.readUInt32LE(s);s+=4;const I=t.readUInt8(s);s+=1;const T=t.readUInt8(s);s+=1;const S=t.readUInt16LE(s);s+=2;const b=t.readUInt32LE(s);s+=4;const k=t.readUInt32LE(s);return s+=4,{traceId:n,parentId:i,spanId:r,seqId:a,totalLength:o,payloadLength:h,payloadType:d,opCode:l,contentType:I,dataType:T,timestamp1:p,timestamp2:u,timestamp3:c,timestamp4:f,timestamp5:g,timestamp6:y,timestamp7:m,extra1:S,extra2:b,extra3:k,payload:t.subarray(s)}}onFragmentData(e){const t=this.readBin(e);this.emit("raw",e),1===t.flag&&1===t.type?(this.appSidePort=t.port2,this.emit("shake:response",t),this.clearShakeTimer(),this.shakeTask.resolve(),this.shakeStatus=3):1===t.flag&&4===t.type||1===t.flag&&5===t.type?(this.emit("message",t.payload),this.emit("read",t)):1===t.flag&&6===t.type?this.emit("log",t.payload):0===t.flag||1===t.flag&&2===t.type&&(this.appSidePort=0)}errorIfBleDisconnect(){if(a()&&!this.ble.connectStatus())throw new P(2,"ble disconnect")}errorIfSideServiceDisconnect(){if(a&&!this.appSidePort)throw new P(3,"side service is not running")}getRequestCount(){return this.handlers.size}onResponse(e){const t=this.handlers.get(e.traceId);t&&t(e)}onMessage(e){const t=this.readPayload(e);let s=this.sessionMgr.getById(t.traceId,t.payloadType);s||(s=this.sessionMgr.newSession(t.traceId,t.payloadType,this),s.on("data",(e=>{1===e.opCode&&(1===e.payloadType?this.emit("request",{request:e,response:({data:t,dataType:s})=>{s=void 0!==s?L(s):e.dataType,this.response({requestId:e.traceId,contentType:e.contentType,dataType:s,data:t})}}):2===e.payloadType?this.emit("response",e):3===e.payloadType&&this.emit("call",e),this.emit("data",e),this.sessionMgr.destroy(s))})),s.on("error",(e=>{this.sessionMgr.destroy(s),this.emit("error",e)}))),s.addChunk(t)}request(e,t){try{this.errorIfBleDisconnect()}catch(e){return Promise.reject(e)}return this.waitingShakePromise.then((()=>{this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect();let s=B;"string"==typeof e?s=w:o(e)?s=k:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(s=B);const n={timeout:6e4,contentType:s,dataType:s},i=q(),r=u();t=Object.assign(n,t),this.handlers.set(i,(({traceId:e,payload:t,dataType:s})=>{let n;switch(this.errorIfBleDisconnect(),this.errorIfSideServiceDisconnect(),s){case 1:n=m(t);break;case 3:default:n=t;break;case 2:n=g(t)}r.resolve(n)})),Buffer.isBuffer(e)?this.sendBuf({requestId:i,buf:e,type:1,contentType:3,dataType:L(t.dataType)}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:3,dataType:L(t.dataType)}):2===L(t.contentType)?this.sendJson({requestId:i,json:e,type:1,contentType:2,dataType:L(t.dataType)}):1===L(t.contentType)?this.sendText({requestId:i,text:e,type:1,contentType:1,dataType:L(t.dataType)}):this.sendBuf({requestId:i,buf:Buffer.from(e),type:1,contentType:3,dataType:L(t.dataType)});let a=!1;return Promise.race([c(t.timeout,((e,s)=>{if(a)return e();s(new P(4,`request timed out in ${t.timeout}ms.`))})),r.promise.finally((()=>{a=!0}))]).catch((e=>{throw e})).finally((()=>{this.handlers.delete(i)}))}))}response({requestId:e,contentType:t,dataType:s,data:n}){3===s?this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:s}):1===s?this.sendText({requestId:e,text:n,type:2,contentType:t,dataType:s}):2===s?this.sendJson({requestId:e,json:n,type:2,contentType:t,dataType:s}):this.sendBuf({requestId:e,buf:n,type:2,contentType:t,dataType:3})}call(e){let t=2;return"string"==typeof e?t=1:o(e)?t=2:(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||Buffer.isBuffer(e))&&(t=3),this.waitingShakePromise.then((()=>Buffer.isBuffer(e)?this.sendBuf({buf:e,type:3,contentType:3,dataType:0}):e instanceof ArrayBuffer||ArrayBuffer.isView(e)?this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0}):2===t?this.sendJson({json:e,type:3,contentType:2,dataType:0}):1===t?this.sendText({text:e,type:3,contentType:1,dataType:0}):this.sendBuf({buf:Buffer.from(e),type:3,contentType:3,dataType:0})))}},D=function(e){return{shakeTimeout:5e3,requestTimeout:6e4,transport:e,onCall(t){return t?(e.on("call",(({contentType:e,payload:s})=>{switch(e){case 2:s=g(s);break;case 1:s=m(s);break;default:s=I(s)}t&&t(s)})),this):this},offOnCall(t){return e.off("call",t),this},call(t){return a()&&e.fork(this.shakeTimeout),t=o(t)?opts.contentType?t:{jsonrpc:R,...t}:t,e.call(t)},onRequest(t){return t?(e.on("request",(e=>{let s=e.request.payload;switch(e.request.contentType){case 2:s=g(s);break;case 1:s=m(s);break;default:s=I(s)}t&&t(s,((t,n,i={})=>2===e.request.contentType&&s?.jsonrpc===R?t?e.response({data:{jsonrpc:R,error:t}}):e.response({data:{jsonrpc:R,result:n}}):e.response({data:n,...i})))})),this):this},cancelAllRequest(){return e.off("response"),this},offOnRequest(t){return e.off("request",t),this},request(t,s={}){return a()&&e.fork(this.shakeTimeout),t=o(t)?s.contentType?t:{jsonrpc:R,...t}:t,e.request(t,{timeout:this.requestTimeout,...s}).then((e=>{if(!o(e)||e.jsonrpc!==R)return e;const{error:t,result:s}=e;if(t)throw t;return s}))},connect(){return e.connect((()=>{})),this},disConnect(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this},start(){return e.listen((()=>{})),this},stop(){return this.cancelAllRequest(),this.offOnRequest(),this.offOnCall(),e.disConnect((()=>{})),this}}}(_),$={onChange(e){return e?(settings.settingsStorage.addListener("change",e),this):this},offChange(){return settings.settingsStorage.removeListener("change"),this},getItem:e=>settings.settingsStorage.getItem(e),setItem:(e,t)=>settings.settingsStorage.setItem(e,t),clear:()=>settings.settingsStorage.clear(),removeItem(e){settings.settingsStorage.removeItem(e)},getAll:()=>settings.settingsStorage.toObject()},j=(F=transferFile,{onFile(e){return e?(void 0===F||F.inbox.on("newfile",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},onSideServiceFileFinished(e){return e?(void 0===F||F.inbox.on("file",(function(){const t=F.inbox.getNextFile();e&&e(t)})),this):this},emitFile(){return F.inbox.emit("file"),this},offFile(){return void 0===F||(F.inbox.off("newfile"),F.inbox.off("file")),this},getFile:()=>void 0===F?null:F.inbox.getNextFile(),sendFile(e,t){if(void 0===F)throw new Error("fileTransfer is not available");return F.outbox.enqueueFile(e,t)}});var F;const O=Object.prototype.hasOwnProperty,A={init(){this.plugins=[],this.settings={},this.mixins=[]},set(e,t){if(1===arguments.length)return this.settings[e];this.settings[e]=t},use(e,...t){return"function"==typeof e?this.plugins.push({handler:e,args:t}):"object"==typeof e&&this.mixins.push({handler:e,args:[]}),this},handle(e){this.plugins.forEach((t=>{t&&"function"==typeof t.handler&&t.handler.call(this,e,...t.args)})),this.mixins.forEach((({handler:{onInit:t,onPause:s,build:n,onResume:i,onDestroy:r,onCreate:a,...o},args:h})=>{Object.assign(e,o)}))}};function M({state:e={},onInit:t,onRun:s,onDestroy:n,...i}={}){const r={state:e,...i,onInit(e){this._onCall=this.onCall?.bind(this),this._onRequest=this.onRequest?.bind(this),this.messaging=D,this.messaging.onCall(this._onCall).onRequest(this.__onRequest.bind(this)),this._onReceivedFile=this.onReceivedFile?.bind(this),j.onSideServiceFileFinished(this._onReceivedFile),this._onSettingsChange=this.onSettingsChange?.bind(this),$.onChange(this._onSettingsChange),this.messaging.start();for(let t=0;t<=M.mixins.length-1;t++){const s=M.mixins[t];s.handler.onInit?.apply(this,e)}t?.apply(this,e),"undefined"!=typeof sideService&&(sideService.launchReasons.settingsChanged&&this._onSettingsChange(sideService.launchArgs),sideService.launchReasons.fileTransfer&&j.emitFile())},onRun(e){for(let t=0;t<=M.mixins.length-1;t++){const s=M.mixins[t];s.handler.onRun?.apply(this,e)}s?.apply(this,e)},onDestroy(e){this._onCall&&this.messaging.offOnCall(this._onCall),this._onRequest&&this.messaging.offOnRequest(this._onRequest),this.messaging.stop(),this._onReceivedFile&&j.offFile(this._onReceivedFile),this._onSettingsChange&&$.offChange(this._onSettingsChange),n?.apply(this,e);for(let t=M.mixins.length-1;t>=0;t--){const s=M.mixins[t];s.handler.onDestroy?.apply(this,e)}},request(e,t={}){return this.messaging.request(e,t)},call(e){return this.messaging.call(e)},fetch:e=>fetch(function(e){const t={timeout:1e4,...e};return t.url=new URL(e.url,t.baseURL).toString(),t}(e)),sendFile:(e,t)=>j.sendFile(e,t),download:(e,t={})=>((e,t)=>network.downloader.downloadFile({url:e,...t}))(e,t),__onRequest(e,t){return"http.request"===e.method?this.httpRequestHandler(e,t):this._onRequest(e,t)},httpRequestHandler(e,t){return this.fetch(e.params).then((e=>{t(null,{status:e.status,statusText:e.statusText,headers:e.headers,body:e.body})})).catch((e=>t({code:1,message:e.message})))}};return M.handle(r),r}var z,H;Logger.getLogger(sideService.appInfo.app.appName),z=M,H=A,Object.getOwnPropertyNames(H).forEach((function(e){if(!O.call(z,e)){var t=Object.getOwnPropertyDescriptor(H,e);Object.defineProperty(z,e,t)}})),M.init();const J={convert:e=>image.convert(e)};export{M as BaseSideService,J as convertLib,$ as settingsLib};
